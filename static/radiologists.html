<!DOCTYPE html>
<html data-theme="dark" lang="en">
<!--
  XRayVision - Async DICOM processor with OpenAI and WebSocket dashboard.
  Copyright (C) 2025 Costin Stroie <costinstroie@eridu.eu.org>

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>XRayVision Radiologists</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.slate.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon-64x64.png" type="image/png" sizes="64x64">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="container">
    <nav>
        <ul>
            <li><strong>XRayVision Radiologists</strong></li>
        </ul>
        <ul>
            <li><a href="/">Dashboard</a></li>
            <li>
                <details class="dropdown">
                    <summary>Statistics</summary>
                    <ul dir="rtl">
                        <li><a href="/stats">Statistics</a></li>
                        <li><a href="/stats/radiologists" class="contrast">Radiologists</a></li>
                        <li><a href="/stats/diagnostics">Diagnostics</a></li>
                        <li><a href="/stats/insights">Insights</a></li>
                    </ul>
                </details>
            </li>
            <li><a href="/check">Check</a></li>
            <li><a href="/about">About</a></li>
        </ul>
    </nav>

    <header class="grid stats-grid">
        <article>
            <strong>Total Radiologists</strong>
            <span id="totalRadiologists">0</span>
        </article>
        <article>
            <strong>Total Reports</strong>
            <span id="totalReports">0</span>
        </article>
        <article>
            <strong>Avg. Severity</strong>
            <span id="avgSeverity">0</span>
        </article>
        <article>
            <strong>AI Validated</strong>
            <span id="aiValidated">0%</span>
        </article>
    </header>

    <main>
        <div id="loadingIndicator" class="loading">
            <p>Loading radiologist statistics...</p>
        </div>

        <div id="errorContainer" style="display: none;">
            <div class="error">
                <p id="errorMessage">Failed to load radiologist statistics. Please try again later.</p>
            </div>
        </div>

        <section id="statsContent" style="display: none;">
            <section class="charts-grid">
                <article class="chart-container">
                    <h3>
                        Reports by Radiologist
                        <button class="secondary outline" onclick="downloadChart('reportsChart')">Download</button>
                    </h3>
                    <div style="position: relative; height: 600px;">
                        <canvas id="reportsChart"></canvas>
                    </div>
                </article>

                <article class="chart-container">
                    <h3>
                        AI Validation Accuracy
                        <button class="secondary outline" onclick="downloadChart('accuracyChart')">Download</button>
                    </h3>
                    <div style="position: relative; height: 600px;">
                        <canvas id="accuracyChart"></canvas>
                    </div>
                </article>
            </section>

            <section>
                <article class="chart-container">
                    <h3>
                        Monthly Trends for Top Radiologists (Last 12 Months)
                        <button class="secondary outline" onclick="downloadChart('monthlyRadiologistsChart')">Download</button>
                    </h3>
                    <div style="position: relative; height: 500px;">
                        <canvas id="monthlyRadiologistsChart"></canvas>
                    </div>
                </article>
            </section>

            <section>
                <h2>Radiologist Details</h2>
                <div class="overflow-auto">
                    <table id="radiologistStats" role="grid">
                        <thead>
                            <tr>
                                <th>Radiologist</th>
                                <th style="text-align: right;">Reports</th>
                                <th style="text-align: right;">Avg Severity</th>
                                <th style="text-align: right;">AI Accuracy</th>
                                <th style="text-align: right;">AI Validated</th>
                                <th>Top Diagnostics</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </section>
        </section>
    </main>

    <script>
        // Chart instances
        let reportsChart, accuracyChart, monthlyRadiologistsChart;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadRadiologistStats();
        });

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('statsContent').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message || 'Failed to load radiologist statistics. Please try again later.';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('statsContent').style.display = 'none';
        }

        function showContent() {
            document.getElementById('statsContent').style.display = 'block';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function extractInitials(name) {
            if (!name || typeof name !== 'string') return "Dr. NoName";
            
            // Check if name starts with "Dr." (case insensitive)
            if (name.toLowerCase().startsWith("dr.")) {
                // Remove "Dr." prefix and extract initials from the rest
                const nameWithoutDr = name.substring(3).trim();
                if (!nameWithoutDr) return "Dr. NoName";
                
                // Split by spaces, hyphens, and carets and take first letter of each part
                const parts = nameWithoutDr.split(/[-^ ]/);
                const initials = parts.map(part => part.charAt(0).toUpperCase() + '.').join('');
                return "Dr. " + initials;
            } else {
                // No "Dr." prefix, just extract initials
                const parts = name.split(/[-^ ]/);
                const initials = parts.map(part => part.charAt(0).toUpperCase() + '.').join('');
                return "Dr. " + initials;
            }
        }

        function loadRadiologistStats() {
            showLoading();

            fetch('/api/stats/radiologists')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                hideLoading();
                updateStats(data);
                showContent();
            })
            .catch(error => {
                console.error('Error loading radiologist stats:', error);
                hideLoading();
                showError('Failed to load radiologist statistics. Please check your connection and try again.');
            });
        }

        function updateStats(data) {
            // Get user role from a hidden element or cookie (simplified approach)
            const isAdmin = true; // This would normally be determined by the server
            
            // Calculate totals
            let totalRadiologists = Object.keys(data).length;
            let totalReports = 0;
            let totalSeverity = 0;
            let totalCompared = 0;
            let totalCorrect = 0;
            
            for (const radiologist in data) {
                totalReports += data[radiologist].report_count;
                totalSeverity += data[radiologist].avg_severity * data[radiologist].report_count;
                totalCompared += data[radiologist].ai_compared;
                // Recalculate accuracy based on totals
                const correct = (data[radiologist].ai_accuracy / 100) * data[radiologist].ai_compared;
                totalCorrect += correct;
            }
            
            const avgSeverity = totalReports > 0 ? (totalSeverity / totalReports).toFixed(1) : 0;
            const aiValidated = totalCompared > 0 ? ((totalCorrect / totalCompared) * 100).toFixed(1) : 0;
            
            // Update header stats
            document.getElementById('totalRadiologists').textContent = totalRadiologists;
            document.getElementById('totalReports').textContent = totalReports;
            document.getElementById('avgSeverity').textContent = avgSeverity;
            document.getElementById('aiValidated').textContent = aiValidated + '%';
            
            // Prepare data for charts
            const radiologists = Object.keys(data);
            const reportCounts = radiologists.map(r => data[r].report_count);
            const accuracies = radiologists.map(r => data[r].ai_accuracy);
            
            // Anonymize names if not admin
            const displayNames = radiologists.map(r => isAdmin ? r : extractInitials(r));
            
            // Destroy existing charts if they exist
            if (reportsChart) reportsChart.destroy();
            if (accuracyChart) accuracyChart.destroy();
            if (monthlyRadiologistsChart) monthlyRadiologistsChart.destroy();
            
            // Chart: Reports by Radiologist
            reportsChart = new Chart(document.getElementById("reportsChart"), {
                type: 'bar',
                data: {
                    labels: displayNames,
                    datasets: [{
                        label: 'Number of Reports',
                        data: reportCounts,
                        backgroundColor: '#0ea5e9',
                        borderColor: '#0ea5e9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    indexAxis: 'y'
                }
            });
            
            // Chart: AI Validation Accuracy
            // Sort data by accuracy (descending) for the accuracy chart
            const accuracyData = radiologists.map((r, i) => ({
                name: isAdmin ? r : extractInitials(r),
                accuracy: accuracies[i]
            })).sort((a, b) => b.accuracy - a.accuracy);
            
            const sortedAccuracyNames = accuracyData.map(item => item.name);
            const sortedAccuracies = accuracyData.map(item => item.accuracy);
            
            accuracyChart = new Chart(document.getElementById("accuracyChart"), {
                type: 'bar',
                data: {
                    labels: sortedAccuracyNames,
                    datasets: [{
                        label: 'AI Validation Accuracy (%)',
                        data: sortedAccuracies,
                        backgroundColor: '#2dd4bf',
                        borderColor: '#2dd4bf',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    indexAxis: 'y'
                }
            });
            
            // Chart: Monthly trends for top radiologists
            // Fetch the monthly trends data
            fetch('/api/stats/radiologists/monthly_trends')
            .then(res => res.json())
            .then(trendsData => {
                // Generate last 12 months labels
                const months = [];
                const now = new Date();
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push(date.toISOString().slice(0, 7)); // YYYY-MM format
                }
                
                // Format month labels for display (e.g., "2024-01" -> "Jan 2024")
                const monthLabels = months.map(month => {
                    const [year, monthNum] = month.split('-');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                });
                
                // Get all unique radiologists across all months
                const allRadiologists = new Set();
                if (trendsData.trends) {
                    for (const month in trendsData.trends) {
                        trendsData.trends[month].forEach(item => {
                            allRadiologists.add(item.radiologist);
                        });
                    }
                }
                
                // Create a color map for radiologists
                const radiologistColors = [
                    '#0ea5e9', '#2dd4bf', '#f59e0b', '#ef4444', '#8b5cf6', 
                    '#ec4899', '#14b8a6', '#f97316', '#6366f1', '#10b981',
                    '#06b6d4', '#8b5cf6', '#f472b6', '#60a5fa', '#34d399'
                ];
                
                const colorMap = {};
                let colorIndex = 0;
                Array.from(allRadiologists).forEach(radiologist => {
                    colorMap[radiologist] = radiologistColors[colorIndex % radiologistColors.length];
                    colorIndex++;
                });
                
                // Create datasets for each radiologist
                const datasets = {};
                Array.from(allRadiologists).forEach(radiologist => {
                    datasets[radiologist] = {
                        label: radiologist,
                        data: new Array(months.length).fill(0),
                        borderColor: colorMap[radiologist],
                        backgroundColor: colorMap[radiologist] + '20',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 3
                    };
                });
                
                // Populate data points
                if (trendsData.trends) {
                    months.forEach((month, monthIndex) => {
                        if (trendsData.trends[month]) {
                            trendsData.trends[month].forEach(item => {
                                if (datasets[item.radiologist]) {
                                    datasets[item.radiologist].data[monthIndex] = item.count;
                                }
                            });
                        }
                    });
                }
                
                // Convert to array and filter out datasets with all zero values
                const monthlyRadiologistDatasets = Object.values(datasets).filter(dataset => 
                    dataset.data.some(count => count > 0)
                );
                
                // Create the chart
                monthlyRadiologistsChart = new Chart(document.getElementById("monthlyRadiologistsChart"), {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: monthlyRadiologistDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            title: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Number of Reports',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading monthly radiologist trends:', error);
                // Create a chart with empty data as fallback
                monthlyRadiologistsChart = new Chart(document.getElementById("monthlyRadiologistsChart"), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Number of Reports',
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            });
            
            // Populate table
            const tbody = document.querySelector('#radiologistStats tbody');
            tbody.innerHTML = '';
            
            // Sort radiologists by report count
            const sortedRadiologists = Object.keys(data).sort((a, b) => data[b].report_count - data[a].report_count);
            
            for (const radiologist of sortedRadiologists) {
                const stats = data[radiologist];
                const displayName = isAdmin ? radiologist : extractInitials(radiologist);
                
                // Format top diagnostics
                let diagnosticsHtml = '';
                if (Object.keys(stats.top_diagnostics).length > 0) {
                    const diagnostics = Object.entries(stats.top_diagnostics)
                        .map(([diag, count]) => `${diag} (${count})`)
                        .join(', ');
                    diagnosticsHtml = `<small>${diagnostics}</small>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <th scope="row">${displayName}</th>
                    <td style="text-align: right;">${stats.report_count}</td>
                    <td style="text-align: right;">${stats.avg_severity}</td>
                    <td style="text-align: right;">${stats.ai_accuracy}%</td>
                    <td style="text-align: right;">${stats.ai_compared}</td>
                    <td>${diagnosticsHtml}</td>
                `;
                tbody.appendChild(row);
            }
        }

        function downloadChart(chartId) {
            const canvas = document.getElementById(chartId);
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `xrayvision-${chartId}-${new Date().toISOString().slice(0, 10)}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>

</html>
