<!DOCTYPE html>
<html data-theme="dark" lang="en">
<!--
  XRayVision - Async DICOM processor with OpenAI and WebSocket dashboard.
  Copyright (C) 2025 Costin Stroie <costinstroie@eridu.eu.org>

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>XRayVision Statistics</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.slate.min.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon-64x64.png" type="image/png" sizes="64x64">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --pico-font-family-sans-serif: Inter, system-ui, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, Helvetica, Arial, "Helvetica Neue", sans-serif, var(--pico-font-family-emoji);
            --pico-font-size: 87.5%;
            --pico-line-height: 1.5;
            --pico-border-radius: 0.5rem;
            --card-border-radius: 0.75rem;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 576px) {
            :root {
                --pico-font-size: 100%;
            }
        }

        @media (min-width: 768px) {
            :root {
                --pico-font-size: 106.25%;
            }
        }

        @media (min-width: 1024px) {
            :root {
                --pico-font-size: 112.5%;
            }
        }

        @media (min-width: 1280px) {
            :root {
                --pico-font-size: 118.75%;
            }
        }

        @media (min-width: 1536px) {
            :root {
                --pico-font-size: 125%;
            }
        }

        h1, h2, h3, h4, h5, h6 {
            --pico-font-weight: 600;
        }

        article {
            border: 1px solid var(--pico-muted-border-color);
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            transition: box-shadow 0.2s ease;
        }

        article:hover {
            box-shadow: var(--card-shadow-hover);
        }

        article>footer {
            border-radius: var(--card-border-radius);
        }

        .stats-grid {
            gap: 1rem;
        }

        .stats-grid article {
            text-align: center;
            padding: 1.25rem 1rem;
        }

        .stats-grid article strong {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--pico-muted-color);
        }

        .stats-grid article span {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .chart-container {
            background-color: var(--pico-background-color);
            padding: 1rem;
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 1rem;
        }

        .chart-container h3 {
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        .chart-container h3 button {
            font-size: 0.8rem;
            padding: 0.2rem 0.4rem;
        }

        table {
            background-color: var(--pico-background-color);
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
        }

        thead th {
            background-color: rgba(30, 30, 40, 0.5);
        }

        tbody tr:hover {
            background-color: rgba(50, 50, 60, 0.3);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--pico-muted-color);
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: var(--pico-color-red-600);
            background-color: var(--pico-color-red-900);
            border-radius: var(--pico-border-radius);
            margin: 1rem 0;
        }

        .charts-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        #trendsChart, #monthlyTrendsChart {
            height: 300px !important;
        }

        #regionChart, #globalChart {
            height: 200px !important;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="container">
    <nav>
        <ul>
            <li><strong>XRayVision Statistics</strong></li>
        </ul>
        <ul>
            <li><a href="/">Dashboard</a></li>
            <li><a href="/stats" class="contrast">Statistics</a></li>
            <li><a href="/about">About</a></li>
            <li>
                <button id="refreshBtn" class="secondary outline" style="margin-left: 1rem; padding: 0.25rem 0.5rem; font-size: 0.9rem;">Refresh</button>
            </li>
        </ul>
    </nav>

    <header>
        <div class="grid stats-grid">
            <article>
                <strong>Total Exams</strong>
                <span id="total">0</span>
            </article>
            <article>
                <strong>Reviewed</strong>
                <span id="reviewed">0</span>
            </article>
            <article>
                <strong>Correct</strong>
                <span id="correct">0</span>
            </article>
            <article>
                <strong>Wrong</strong>
                <span id="wrong">0</span>
            </article>
            <article>
                <strong>Avg. Processing</strong>
                <span id="avg-time">0s</span>
            </article>
            <article>
                <strong>Throughput</strong>
                <span id="throughput">0/h</span>
            </article>
        </div>
    </header>

    <main>
        <div id="loadingIndicator" class="loading">
            <p>Loading statistics...</p>
        </div>
        
        <div id="errorContainer" style="display: none;">
            <div class="error">
                <p id="errorMessage">Failed to load statistics. Please try again later.</p>
            </div>
        </div>

        <section id="statsContent" style="display: none;">
            <section>
                <h2>Breakdown by Anatomical Region</h2>
                <div class="overflow-auto">
                    <table id="regionStats" role="grid">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th style="text-align: right;">Total</th>
                                <th style="text-align: right;">Reviewed</th>
                                <th style="text-align: right;">Positive</th>
                                <th style="text-align: right;">Invalid</th>
                                <th style="text-align: right;"><abbr title="Positive Predictive Value">PPV</abbr> (%)<br><small>TP / (TP + FP)</small></th>
                                <th style="text-align: right;"><abbr title="Negative Predictive Value">PNV</abbr> (%)<br><small>TN / (TN + FN)</small></th>
                                <th style="text-align: right;"><abbr title="Sensitivity">Sensitivity</abbr> (%)<br><small>TP / (TP + FN)</small></th>
                                <th style="text-align: right;"><abbr title="Specificity">Specificity</abbr> (%)<br><small>TN / (TN + FP)</small></th>
                                <th style="text-align: right;"><abbr title="Matthews Correlation Coefficient">MCC</abbr></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- dynamically populated -->
                        </tbody>
                        <tfoot>
                            <!-- dynamically populated -->
                        </tfoot>
                    </table>
                </div>
            </section>
            
            <section>
                <h2>Confusion Matrices by Region</h2>
                <div id="confusionMatrices" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    <!-- dynamically populated -->
                </div>
            </section>
            
            <section class="grid charts-grid">
                <article class="chart-container">
                    <h3>
                        Studies by Anatomic Region
                        <button class="secondary outline" onclick="downloadChart('regionChart')">Download</button>
                    </h3>
                    <canvas id="regionChart" width="400" height="200"></canvas>
                </article>
                <article class="chart-container">
                    <h3>
                        Global Summary
                        <button class="secondary outline" onclick="downloadChart('globalChart')">Download</button>
                    </h3>
                    <canvas id="globalChart" width="400" height="200"></canvas>
                </article>
            </section>
            
            <section class="chart-container">
                <h3>
                    Temporal Trends by Region (Last 30 Days)
                    <button class="secondary outline" onclick="downloadChart('trendsChart')">Download</button>
                </h3>
                <canvas id="trendsChart" width="400" height="300"></canvas>
            </section>
            
            <section class="chart-container">
                <h3>
                    Monthly Trends by Region (Last 12 Months)
                    <button class="secondary outline" onclick="downloadChart('monthlyTrendsChart')">Download</button>
                </h3>
                <canvas id="monthlyTrendsChart" width="400" height="300"></canvas>
            </section>
        </section>
    </main>

    <script>
        // Consistent color palette
        const chartColors = {
            positive: '#2dd4bf',
            negative: '#64748b',
            falsePositive: '#f59e0b',
            falseNegative: '#f87171',
            total: '#0ea5e9',
            invalid: '#f87171',
            primary: '#0ea5e9',
            secondary: '#2dd4bf',
            accent: '#f59e0b'
        };

        // Chart instances
        let regionChart, globalChart, trendsChart, monthlyTrendsChart;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            document.getElementById('refreshBtn').addEventListener('click', loadStats);
        });

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('statsContent').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message || 'Failed to load statistics. Please try again later.';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('statsContent').style.display = 'none';
        }

        function showContent() {
            document.getElementById('statsContent').style.display = 'block';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function loadStats() {
            showLoading();
            
            fetch('/api/stats')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                hideLoading();
                updateStats(data);
                showContent();
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                hideLoading();
                showError('Failed to load statistics. Please check your connection and try again.');
            });
        }

        function updateStats(data) {
            document.getElementById('total').textContent = data.total;
            document.getElementById('reviewed').textContent = data.reviewed;
            
            // Use correct and wrong values from backend
            document.getElementById('correct').textContent = data.correct;
            document.getElementById('wrong').textContent = data.wrong;
            
            document.getElementById('avg-time').textContent = data.avg_processing_time ? `${data.avg_processing_time}s` : '0s';
            document.getElementById('throughput').textContent = data.throughput ? `${data.throughput}/h` : '0/h';

            // Table
            const tbody = document.querySelector('#regionStats tbody');
            tbody.innerHTML = '';
            for (const [region, counts] of Object.entries(data.region)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <th scope="row">${region}</th>
                    <td style="text-align: right;">${counts.total}</td>
                    <td style="text-align: right;">${counts.reviewed}</td>
                    <td style="text-align: right;">${counts.positive}</td>
                    <td style="text-align: right;">${counts.invalid}</td>
                    <td style="text-align: right;">${counts.ppv !== '-' ? counts.ppv + '%' : '-'}</td>
                    <td style="text-align: right;">${counts.pnv !== '-' ? counts.pnv + '%' : '-'}</td>
                    <td style="text-align: right;">${counts.snsi !== '-' ? counts.snsi + '%' : '-'}</td>
                    <td style="text-align: right;">${counts.spci !== '-' ? counts.spci + '%' : '-'}</td>
                    <td style="text-align: right;">${counts.mcc !== undefined ? (() => {
                        const mcc = counts.mcc;
                        let color = '';
                        if (mcc >= 0.9) color = '#34d399';  // green
                        else if (mcc >= 0.8) color = '#2dd4bf';  // teal
                        else if (mcc >= 0.7) color = '#60a5fa';  // blue
                        else if (mcc >= 0.5) color = '#a78bfa';  // purple
                        else if (mcc >= 0.3) color = '#fbbf24';  // yellow
                        else if (mcc >= 0.0) color = '#f87171';  // red
                        else color = '#ef4444';  // darker red
                        return `<span style="color: ${color}; font-weight: bold;">${mcc.toFixed(2)}</span>`;
                    })() : '-'}</td>
                `;
                tbody.appendChild(row);
            }
            const tfoot = document.querySelector('#regionStats tfoot');
            // Calculate totals for all metrics
            let totalTpos = 0, totalTneg = 0, totalFpos = 0, totalFneg = 0;
            for (const [region, counts] of Object.entries(data.region)) {
                totalTpos += counts.tpos || 0;
                totalTneg += counts.tneg || 0;
                totalFpos += counts.fpos || 0;
                totalFneg += counts.fneg || 0;
            }
            // Calculate aggregate metrics
            const totalPpv = (totalTpos + totalFpos) > 0 ? Math.round(100 * totalTpos / (totalTpos + totalFpos)) : '-';
            const totalPnv = (totalTneg + totalFneg) > 0 ? Math.round(100 * totalTneg / (totalTneg + totalFneg)) : '-';
            const totalSnsi = (totalTpos + totalFneg) > 0 ? Math.round(100 * totalTpos / (totalTpos + totalFneg)) : '-';
            const totalSpci = (totalTneg + totalFpos) > 0 ? Math.round(100 * totalTneg / (totalTneg + totalFpos)) : '-';
            
            // Calculate Matthews Correlation Coefficient (MCC) for totals
            const tp = totalTpos;
            const tn = totalTneg;
            const fp = totalFpos;
            const fn = totalFneg;
            let totalMcc = '-';
            const denominator = Math.sqrt((tp + fp) * (tp + fn) * (tn + fp) * (tn + fn));
            if (denominator !== 0) {
                const mcc = (tp * tn - fp * fn) / denominator;
                totalMcc = mcc.toFixed(2);
            }
            
            tfoot.innerHTML = `
            <tr>
                <th scope="row">Total</th>
                <td style="text-align: right;">${data.total}</td>
                <td style="text-align: right;">${data.reviewed}</td>
                <td style="text-align: right;">${data.positive}</td>
                <td style="text-align: right;">${data.invalid}</td>
                <td style="text-align: right;">${totalPpv}%</td>
                <td style="text-align: right;">${totalPnv}%</td>
                <td style="text-align: right;">${totalSnsi}%</td>
                <td style="text-align: right;">${totalSpci}%</td>
                <td style="text-align: right;">${(() => {
                    if (totalMcc === '-') return '-';
                    const mcc = parseFloat(totalMcc);
                    let color = '';
                    if (mcc >= 0.9) color = '#34d399';  // green
                    else if (mcc >= 0.8) color = '#2dd4bf';  // teal
                    else if (mcc >= 0.7) color = '#60a5fa';  // blue
                    else if (mcc >= 0.5) color = '#a78bfa';  // purple
                    else if (mcc >= 0.3) color = '#fbbf24';  // yellow
                    else if (mcc >= 0.0) color = '#f87171';  // red
                    else color = '#ef4444';  // darker red
                    return `<span style="color: ${color}; font-weight: bold;">${totalMcc}</span>`;
                })()}</td>
            </tr>`;

            // Populate confusion matrices
            const matricesContainer = document.getElementById('confusionMatrices');
            matricesContainer.innerHTML = '';
            
            for (const [region, counts] of Object.entries(data.region)) {
                const tpos = counts.tpos || 0;
                const tneg = counts.tneg || 0;
                const fpos = counts.fpos || 0;
                const fneg = counts.fneg || 0;
                
                const matrixHtml = `
                    <article class="confusion-matrix" style="padding: 1rem;">
                        <h3 style="margin-top: 0; text-align: center;">${region}</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div></div>
                            <div style="font-weight: bold; padding: 0.5rem;">Predicted</div>
                            <div></div>
                            
                            <div style="font-weight: bold; padding: 0.5rem; writing-mode: vertical-rl; text-orientation: mixed; height: 100px;">Actual</div>
                            <div style="background-color: rgba(45, 212, 191, 0.2); padding: 0.5rem; border: 1px solid #2dd4bf;">
                                <div>Positive</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${tpos}</div>
                                <div style="font-size: 0.8rem;">TP</div>
                            </div>
                            <div style="background-color: rgba(248, 113, 113, 0.2); padding: 0.5rem; border: 1px solid #f87171;">
                                <div>Positive</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${fneg}</div>
                                <div style="font-size: 0.8rem;">FN</div>
                            </div>
                            
                            <div></div>
                            <div style="background-color: rgba(248, 113, 113, 0.2); padding: 0.5rem; border: 1px solid #f87171;">
                                <div>Negative</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${fpos}</div>
                                <div style="font-size: 0.8rem;">FP</div>
                            </div>
                            <div style="background-color: rgba(100, 116, 139, 0.2); padding: 0.5rem; border: 1px solid #64748b;">
                                <div>Negative</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${tneg}</div>
                                <div style="font-size: 0.8rem;">TN</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.9rem; text-align: center;">
                            <div>MCC: ${(() => {
                                const mcc = counts.mcc;
                                if (mcc === undefined) return '<span style="color: #f87171;">0.00 (Poor)</span>';
                                const mccValue = mcc.toFixed(2);
                                let interpretation = '';
                                let color = '';
                                if (mcc >= 0.9) {
                                    interpretation = ' (Excellent)';
                                    color = '#34d399';  // green
                                }
                                else if (mcc >= 0.8) {
                                    interpretation = ' (Very Good)';
                                    color = '#2dd4bf';  // teal
                                }
                                else if (mcc >= 0.7) {
                                    interpretation = ' (Good)';
                                    color = '#60a5fa';  // blue
                                }
                                else if (mcc >= 0.5) {
                                    interpretation = ' (Moderate)';
                                    color = '#a78bfa';  // purple
                                }
                                else if (mcc >= 0.3) {
                                    interpretation = ' (Fair)';
                                    color = '#fbbf24';  // yellow
                                }
                                else if (mcc >= 0.0) {
                                    interpretation = ' (Poor)';
                                    color = '#f87171';  // red
                                }
                                else {
                                    interpretation = ' (Very Poor)';
                                    color = '#ef4444';  // darker red
                                }
                                return `<span style="color: ${color};">${mccValue}${interpretation}</span>`;
                            })()}</div>
                        </div>
                    </article>
                `;
                
                matricesContainer.innerHTML += matrixHtml;
            }

            // Destroy existing charts if they exist
            if (regionChart) regionChart.destroy();
            if (globalChart) globalChart.destroy();
            if (trendsChart) trendsChart.destroy();
            if (monthlyTrendsChart) monthlyTrendsChart.destroy();

            // Chart: region breakdown
            const regionLabels = [];
            const tposData = [];
            const tnegData = [];
            const fposData = [];
            const fnegData = [];

            for (const [region, counts] of Object.entries(data.region)) {
                regionLabels.push(region);
                tposData.push(counts.tpos || 0);
                tnegData.push(counts.tneg || 0);
                fposData.push(counts.fpos || 0);
                fnegData.push(counts.fneg || 0);
            }

            regionChart = new Chart(document.getElementById("regionChart"), {
                type: 'bar',
                data: {
                    labels: regionLabels,
                    datasets: [
                        { 
                            label: 'True Positive', 
                            data: tposData, 
                            backgroundColor: chartColors.positive,
                            borderColor: chartColors.positive,
                            borderWidth: 1
                        },
                        { 
                            label: 'True Negative', 
                            data: tnegData, 
                            backgroundColor: chartColors.negative,
                            borderColor: chartColors.negative,
                            borderWidth: 1
                        },
                        { 
                            label: 'False Positive', 
                            data: fposData, 
                            backgroundColor: chartColors.falsePositive,
                            borderColor: chartColors.falsePositive,
                            borderWidth: 1
                        },
                        { 
                            label: 'False Negative', 
                            data: fnegData, 
                            backgroundColor: chartColors.falseNegative,
                            borderColor: chartColors.falseNegative,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    indexAxis: 'y'
                }
            });

            // Chart: Global summary
            globalChart = new Chart(document.getElementById("globalChart"), {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Invalid'],
                    datasets: [{
                        data: [data.positive, data.total - data.positive - data.invalid, data.invalid],
                        backgroundColor: [
                            chartColors.positive,
                            chartColors.negative,
                            chartColors.invalid
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    cutout: '60%'
                }
            });
            
            // Chart: Temporal trends
            const trendDates = [...new Set(Object.values(data.trends).flatMap(region => region.map(item => item.date)))].sort();
            
            // Prepare datasets for each region
            const trendDatasets = [];
            const regionColors = [
                chartColors.primary, chartColors.secondary, chartColors.accent, 
                '#a78bfa', '#f472b6', '#60a5fa', '#34d399', '#fbbf24', '#fb7185'
            ];
            let colorIndex = 0;
            
            for (const [region, regionData] of Object.entries(data.trends)) {
                // Create data points for all dates
                const dataPoints = trendDates.map(date => {
                    const dayData = regionData.find(item => item.date === date);
                    return dayData ? dayData.total : 0;
                });
                
                trendDatasets.push({
                    label: region,
                    data: dataPoints,
                    borderColor: regionColors[colorIndex % regionColors.length],
                    backgroundColor: regionColors[colorIndex % regionColors.length] + '20',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 3
                });
                
                colorIndex++;
            }
            
            trendsChart = new Chart(document.getElementById("trendsChart"), {
                type: 'line',
                data: {
                    labels: trendDates,
                    datasets: trendDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Studies',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Chart: Monthly trends
            const monthlyTrendMonths = [...new Set(Object.values(data.monthly_trends).flatMap(region => region.map(item => item.month)))].sort();
            
            // Prepare datasets for each region
            const monthlyTrendDatasets = [];
            const monthlyRegionColors = [
                chartColors.primary, chartColors.secondary, chartColors.accent,
                '#a78bfa', '#f472b6', '#60a5fa', '#34d399', '#fbbf24', '#fb7185'
            ];
            let monthlyColorIndex = 0;
            
            for (const [region, regionData] of Object.entries(data.monthly_trends)) {
                // Create data points for all months
                const dataPoints = monthlyTrendMonths.map(month => {
                    const monthData = regionData.find(item => item.month === month);
                    return monthData ? monthData.total : 0;
                });
                
                monthlyTrendDatasets.push({
                    label: region,
                    data: dataPoints,
                    borderColor: monthlyRegionColors[monthlyColorIndex % monthlyRegionColors.length],
                    backgroundColor: monthlyRegionColors[monthlyColorIndex % monthlyRegionColors.length] + '20',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 3
                });
                
                monthlyColorIndex++;
            }
            
            monthlyTrendsChart = new Chart(document.getElementById("monthlyTrendsChart"), {
                type: 'line',
                data: {
                    labels: monthlyTrendMonths,
                    datasets: monthlyTrendDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Studies',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function downloadChart(chartId) {
            const canvas = document.getElementById(chartId);
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `xrayvision-${chartId}-${new Date().toISOString().slice(0, 10)}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>

</html>
