<!DOCTYPE html>
<html data-theme="dark" lang="en">
<!--
  XRayVision - Async DICOM processor with OpenAI and WebSocket dashboard.
  Copyright (C) 2025 Costin Stroie <costinstroie@eridu.eu.org>

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>XRayVision Report Check</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.slate.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon-64x64.png" type="image/png" sizes="64x64">
</head>
<body class="container">
    <nav>
        <ul>
            <li><strong>XRayVision Report Checker</strong></li>
        </ul>
        <ul>
            <li><a href="/">Dashboard</a></li>
            <li>
                <details class="dropdown">
                    <summary>Statistics</summary>
                    <ul dir="rtl">
                        <li><a href="/stats">Statistics</a></li>
                        <li><a href="/stats/radiologists">Radiologists</a></li>
                        <li><a href="/stats/diagnostics">Diagnostics</a></li>
                        <li><a href="/stats/insights">Insights</a></li>
                    </ul>
                </details>
            </li>
            <li><a href="/check" class="contrast">Check</a></li>
            <li><a href="/about">About</a></li>
        </ul>
    </nav>
    <main>
        <hgroup>
            <h2>Report Analysis</h2>
            <p>Enter a radiology report to analyze for pathological findings and detailed insights</p>
        </hgroup>
        <header id="result" class="grid stats-grid" style="display: none;">
            <!-- Results will be cloned from template -->
        </header>
        <main id="detailed-analysis" style="margin-top: 1rem; display: none;">
            <h3>Detailed Analysis</h3>
            <div id="detailed-content" style="padding: 1rem; background-color: rgba(30, 30, 40, 0.5); border-radius: 0.5rem; margin-top: 0.5rem;"></div>
        </main>
        <form id="check-form" style="margin-top: 1rem;">
            <textarea id="report-text" name="report" placeholder="Enter radiology report text here..." rows="8" required></textarea>
            <fieldset role="group">
                <button type="submit" id="check-btn" form="check-form">Quick Check</button>
                <button type="button" id="analyse-btn">Detailed Analysis</button>
            </fieldset>
        </form>
    </main>

    <!-- Template for result cards -->
    <template id="result-template">
        <article>
            <strong data-field="label"></strong>
            <span data-field="value">-</span>
        </article>
    </template>
        
    <template id="detailed-analysis-template">
        <section>
            <h4 style="margin-bottom: 0.5rem; color: #60a5fa;" data-field="title"></h4>
            <div data-field="content"></div>
        </section>
    </template>
        
    <template id="list-item-template">
        <li data-field="text"></li>
    </template>

    <script>
        function colorizePathologic(element, value) {
            // Ensure only "yes" or "no" values are displayed
            const normalizedValue = (value === "yes" || value === "no") ? value : "no";
            element.textContent = normalizedValue;
            if (normalizedValue === "no") {
                element.style.color = "#2dd4bf"; // green
            } else {
                element.style.color = "#f87171"; // red
            }
        }
        
        function colorizeSeverity(element, value) {
            element.textContent = value;
            const severity = parseInt(value);
            if (!isNaN(severity)) {
                // Calculate color from green (0) to red (10)
                const red = Math.min(255, Math.floor(severity * 25.5));
                const green = Math.min(255, Math.floor((10 - severity) * 25.5));
                element.style.color = `rgb(${red}, ${green}, 0)`;
            }
        }
        
        function createResultCard(label, value) {
            const template = document.getElementById('result-template');
            const clone = template.content.cloneNode(true);
            
            // Set the label
            const labelElement = clone.querySelector('[data-field="label"]');
            labelElement.textContent = label;
            
            // Set the value
            const valueElement = clone.querySelector('[data-field="value"]');
            valueElement.textContent = value;
            
            return clone;
        }
        
        function displayResults(data) {
            const resultContainer = document.getElementById('result');
            if (!resultContainer) {
                console.error('Result container not found');
                return;
            }
            
            resultContainer.innerHTML = '';
            
            // Create and append cards for each result field
            const pathologicCard = createResultCard('Pathologic', data.pathologic || 'N/A');
            const severityCard = createResultCard('Severity', data.severity !== undefined ? data.severity : 'N/A');
            const summaryCard = createResultCard('Summary', data.summary || 'N/A');
            
            resultContainer.appendChild(pathologicCard);
            resultContainer.appendChild(severityCard);
            resultContainer.appendChild(summaryCard);
            
            // Apply colorization
            const pathologicElement = resultContainer.querySelectorAll('[data-field="value"]')[0];
            const severityElement = resultContainer.querySelectorAll('[data-field="value"]')[1];
            
            if (pathologicElement) {
                colorizePathologic(pathologicElement, data.pathologic || 'N/A');
            }
            if (severityElement) {
                colorizeSeverity(severityElement, data.severity !== undefined ? data.severity : 'N/A');
            }
            
            // Show the results container
            resultContainer.style.display = 'grid';
        }
        
        function displayDetailedAnalysis(data) {
            const detailedContent = document.getElementById("detailed-content");
            const detailedAnalysis = document.getElementById("detailed-analysis");
            
            // Check if elements exist
            if (!detailedContent || !detailedAnalysis) {
                console.error('Detailed analysis elements not found');
                return;
            }
            
            // Clear previous content
            detailedContent.innerHTML = '<div style="margin-bottom: 1rem;"></div>';
            const container = detailedContent.firstChild;
            
            // First Pass - Overview and Context
            const firstPassTemplate = document.getElementById('detailed-analysis-template');
            const firstPassSection = firstPassTemplate.content.cloneNode(true);
            firstPassSection.querySelector('[data-field="title"]').textContent = 'First Pass - Overview and Context';
            
            const firstPassContent = document.createElement('div');
            if (data.first_pass) {
                firstPassContent.innerHTML = `
                    <p><strong>Topic:</strong> ${data.first_pass.topic || 'N/A'}</p>
                    <p><strong>Purpose:</strong> ${data.first_pass.purpose || 'N/A'}</p>
                    <p><strong>Primary Findings:</strong> ${data.first_pass.primary_findings || 'N/A'}</p>
                `;
            } else {
                firstPassContent.innerHTML = `
                    <p><strong>Topic:</strong> N/A</p>
                    <p><strong>Purpose:</strong> N/A</p>
                    <p><strong>Primary Findings:</strong> N/A</p>
                `;
            }
            firstPassSection.querySelector('[data-field="content"]').appendChild(firstPassContent);
            container.appendChild(firstPassSection);
            
            // Second Pass - Detailed Content Analysis
            const secondPassTemplate = document.getElementById('detailed-analysis-template');
            const secondPassSection = secondPassTemplate.content.cloneNode(true);
            secondPassSection.querySelector('[data-field="title"]').textContent = 'Second Pass - Detailed Content Analysis';
            
            const secondPassContent = document.createElement('div');
            if (data.second_pass) {
                let secondHtml = '';
                if (data.second_pass.main_points && data.second_pass.main_points.length > 0) {
                    secondHtml += '<p><strong>Main Points:</strong></p><ul>';
                    data.second_pass.main_points.forEach(point => {
                        const listItemTemplate = document.getElementById('list-item-template');
                        const listItem = listItemTemplate.content.cloneNode(true);
                        listItem.querySelector('[data-field="text"]').textContent = point;
                        secondHtml += listItem.querySelector('li').outerHTML;
                    });
                    secondHtml += '</ul>';
                }
                if (data.second_pass.supporting_evidence && data.second_pass.supporting_evidence.length > 0) {
                    secondHtml += '<p><strong>Supporting Evidence:</strong></p><ul>';
                    data.second_pass.supporting_evidence.forEach(evidence => {
                        const listItemTemplate = document.getElementById('list-item-template');
                        const listItem = listItemTemplate.content.cloneNode(true);
                        listItem.querySelector('[data-field="text"]').textContent = evidence;
                        secondHtml += listItem.querySelector('li').outerHTML;
                    });
                    secondHtml += '</ul>';
                }
                secondHtml += `<p><strong>Conclusions Valid:</strong> ${data.second_pass.conclusions_valid ? 'Yes' : 'No'}</p>`;
                secondPassContent.innerHTML = secondHtml;
            } else {
                secondPassContent.innerHTML = `
                    <p><strong>Main Points:</strong> N/A</p>
                    <p><strong>Supporting Evidence:</strong> N/A</p>
                    <p><strong>Conclusions Valid:</strong> N/A</p>
                `;
            }
            secondPassSection.querySelector('[data-field="content"]').appendChild(secondPassContent);
            container.appendChild(secondPassSection);
            
            // Third Pass - Critical Evaluation
            const thirdPassTemplate = document.getElementById('detailed-analysis-template');
            const thirdPassSection = thirdPassTemplate.content.cloneNode(true);
            thirdPassSection.querySelector('[data-field="title"]').textContent = 'Third Pass - Critical Evaluation';
            
            const thirdPassContent = document.createElement('div');
            if (data.third_pass) {
                let thirdHtml = '';
                if (data.third_pass.assumptions && data.third_pass.assumptions.length > 0) {
                    thirdHtml += '<p><strong>Assumptions:</strong></p><ul>';
                    data.third_pass.assumptions.forEach(assumption => {
                        const listItemTemplate = document.getElementById('list-item-template');
                        const listItem = listItemTemplate.content.cloneNode(true);
                        listItem.querySelector('[data-field="text"]').textContent = assumption;
                        thirdHtml += listItem.querySelector('li').outerHTML;
                    });
                    thirdHtml += '</ul>';
                }
                if (data.third_pass.missing_info && data.third_pass.missing_info.length > 0) {
                    thirdHtml += '<p><strong>Missing Information:</strong></p><ul>';
                    data.third_pass.missing_info.forEach(info => {
                        const listItemTemplate = document.getElementById('list-item-template');
                        const listItem = listItemTemplate.content.cloneNode(true);
                        listItem.querySelector('[data-field="text"]').textContent = info;
                        thirdHtml += listItem.querySelector('li').outerHTML;
                    });
                    thirdHtml += '</ul>';
                }
                thirdHtml += `<p><strong>Critique:</strong> ${data.third_pass.critique || 'N/A'}</p>`;
                thirdPassContent.innerHTML = thirdHtml;
            } else {
                thirdPassContent.innerHTML = `
                    <p><strong>Assumptions:</strong> N/A</p>
                    <p><strong>Missing Information:</strong> N/A</p>
                    <p><strong>Critique:</strong> N/A</p>
                `;
            }
            thirdPassSection.querySelector('[data-field="content"]').appendChild(thirdPassContent);
            container.appendChild(thirdPassSection);
            
            // Overall Assessment
            const overallTemplate = document.getElementById('detailed-analysis-template');
            const overallSection = overallTemplate.content.cloneNode(true);
            overallSection.querySelector('[data-field="title"]').textContent = 'Overall Assessment';
            
            const overallContent = document.createElement('div');
            overallContent.innerHTML = `<p>${data.overall_assessment || 'N/A'}</p>`;
            overallSection.querySelector('[data-field="content"]').appendChild(overallContent);
            container.appendChild(overallSection);
            
            detailedAnalysis.style.display = "block";
            
            // Scroll to detailed analysis
            detailedAnalysis.scrollIntoView({ behavior: "smooth" });
        }
        
        document.getElementById("check-btn").addEventListener("click", function (e) {
            e.preventDefault();
            const reportText = document.getElementById("report-text").value.trim();
            const submitButton = document.getElementById("check-btn");
            
            if (!reportText) {
                alert("Please enter a report to analyze");
                return;
            }

            // Disable the submit button
            submitButton.disabled = true;
            submitButton.textContent = "Checking...";

            fetch('/api/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report: reportText })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Display results using template
                displayResults(data);
                
                // Hide detailed analysis if shown
                document.getElementById("detailed-analysis").style.display = "none";
                
                // Scroll to results
                document.getElementById("result").scrollIntoView({ behavior: "smooth" });
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while analyzing the report. Please try again.");
            })
            .finally(() => {
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.textContent = "Quick Check";
            });
        });
        
        document.getElementById("analyse-btn").addEventListener("click", function (e) {
            e.preventDefault();
            const reportText = document.getElementById("report-text").value.trim();
            const analyseButton = document.getElementById("analyse-btn");
            
            if (!reportText) {
                alert("Please enter a report to analyze");
                return;
            }

            // Disable the analyse button
            analyseButton.disabled = true;
            analyseButton.textContent = "Analysing...";

            fetch('/api/analyse', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report: reportText })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }
                
                // Display detailed analysis
                displayDetailedAnalysis(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while analyzing the report. Please try again.");
            })
            .finally(() => {
                // Re-enable the analyse button
                analyseButton.disabled = false;
                analyseButton.textContent = "Detailed Analysis";
            });
        });
    </script>
</body>
</html>
