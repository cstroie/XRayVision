<!DOCTYPE html>
<html data-theme="dark" lang="en">
<!--
  XRayVision - Async DICOM processor with OpenAI and WebSocket dashboard.
  Copyright (C) 2025 Costin Stroie <costinstroie@eridu.eu.org>

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  any later version.
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>XRayVision Report Check</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.colors.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.slate.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/static/favicon-64x64.png" type="image/png" sizes="64x64">
</head>
<body class="container">
    <nav>
        <ul>
            <li><strong>XRayVision Report Checker</strong></li>
        </ul>
        <ul>
            <li><a href="/">Dashboard</a></li>
            <li><a href="/stats">Statistics</a></li>
            <li><a href="/check" class="contrast">Check</a></li>
            <li><a href="/about">About</a></li>
        </ul>
    </nav>
    <main>
        <hgroup>
            <h2>Report Checker</h2>
            <p>Enter a radiology report to analyze for pathological findings</p>
        </hgroup>
        <header id="result" class="grid stats-grid">
            <article>
                <strong>Pathologic</strong>
                <span id="pathologic"></span>
            </article>
            <article>
                <strong>Severity</strong>
                <span id="severity"></span>
            </article>
            <article>
                <strong>Summary</strong>
                <span id="summary"></span>
            </article>
        </header>
        <form id="check-form">
            <textarea id="report-text" name="report" placeholder="Enter radiology report text here..." rows="5" required></textarea>
            <button type="submit" form="check-form">Analyze Report</button>
        </form>
    </main>

    <script>
        document.getElementById("check-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const reportText = document.getElementById("report-text").value.trim();
            const submitButton = document.querySelector("#check-form button[type='submit']");
            
            if (!reportText) {
                alert("Please enter a report to analyze");
                return;
            }

            // Disable the submit button
            submitButton.disabled = true;
            submitButton.textContent = "Analyzing...";

            fetch('/api/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report: reportText })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Colorize pathologic text (green for "no", red for "yes")
                const pathologicElement = document.getElementById("pathologic");
                pathologicElement.textContent = data.pathologic;
                if (data.pathologic === "no") {
                    pathologicElement.style.color = "#2dd4bf"; // green
                } else {
                    pathologicElement.style.color = "#f87171"; // red
                }
                
                // Color scale for severity (green to red based on 1-10 scale)
                const severityElement = document.getElementById("severity");
                severityElement.textContent = data.severity;
                const severity = parseInt(data.severity);
                if (!isNaN(severity)) {
                    // Calculate color from green (0) to red (10)
                    const red = Math.min(255, Math.floor(severity * 25.5));
                    const green = Math.min(255, Math.floor((10 - severity) * 25.5));
                    severityElement.style.color = `rgb(${red}, ${green}, 0)`;
                }
                
                document.getElementById("summary").textContent = data.summary;
                
                const resultElement = document.getElementById("result");
                resultElement.classList.add("show");
                resultElement.className = "show";
                
                // Scroll to results
                resultElement.scrollIntoView({ behavior: "smooth" });
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while analyzing the report. Please try again.");
            })
            .finally(() => {
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.textContent = "Analyze Report";
            });
        });
    </script>
</body>
</html>
